COMPILE = c++

FLAGS = -Wall -Werror -Wextra -std=c++11

MAIN = main.cpp

#directories
OBJDIR = obj
SRC_DIR = src
REQ_DIR = request
CONFIG_DIR = config
TARGET_DIR = resolved_target
UTILS_DIR = utils
CGI_DIR = cgi
RESP_DIR = response
ERR_DIR = err
SERV_DIR = server
CONN_DIR = connection
DIR_VAL = directive_validation

REQUEST = $(addprefix $(SRC_DIR)/$(REQ_DIR)/,	chunked_parser.cpp \
											header_field_parser.cpp \
											request_line_parser.cpp \
											request.cpp \
											request_parser.cpp \
											request_target_parser.cpp \
											request_validator.cpp \
											uri_host_parser.cpp \
											uri.cpp)

CONFIG = $(addprefix $(SRC_DIR)/$(CONFIG_DIR)/,	config_interface.cpp \
												setup.cpp \
												server_name.cpp \
												server_context.cpp \
												server_context_setters.cpp \
												server_context_verification.cpp \
												listen.cpp \
												location_context.cpp \
												location_context_setters.cpp \
												location_context_verification.cpp \
												nginx_config.cpp \
												nginx_config_get_servers.cpp \
												nginx_config_file_handler.cpp)

CONFIG_VAL = $(addprefix $(SRC_DIR)/$(CONFIG_DIR)/$(DIR_VAL)/,	client_max_body_size.cpp \
															allowed_methods.cpp \
															autoindex.cpp \
															cgi_pass.cpp \
															cgi_pass_parser.cpp \
															index.cpp \
															location_uri.cpp \
															return_dir.cpp \
															root.cpp)


TARGET = 	$(addprefix $(SRC_DIR)/$(TARGET_DIR)/,	server_selection.cpp \
													resolved_path.cpp \
													location_selection.cpp \
													target_config.cpp)

UTILS = 	$(addprefix $(SRC_DIR)/$(UTILS_DIR)/,	file_handling.cpp \
													is_functions.cpp \
													request_utils.cpp \
													cgi_utils.cpp \
													config_utils.cpp \
													status_codes.cpp\
													mime_types.cpp)

CGI = $(addprefix $(SRC_DIR)/$(CGI_DIR)/, 	cgi.cpp \
											cgi_argv_envp.cpp \
											cgi_file_validation.cpp \
											cgi_parent_child.cpp \
											cgi_pathfinder.cpp \
											cgi_handler.cpp )

RESPONSE = $(addprefix $(SRC_DIR)/$(RESP_DIR)/, file_handler.cpp \
												response_handler.cpp \
												response_generator.cpp\
												response.cpp)

CONNECTION = $(addprefix $(SRC_DIR)/$(CONN_DIR)/, connection.cpp)

SERVER = $(addprefix $(SRC_DIR)/$(SERV_DIR)/, kernel_events.cpp \
												socket.cpp)

ERROR = $(addprefix $(SRC_DIR)/$(ERR_DIR)/,	error_responses.cpp)

OFILES =	$(CONFIG:.cpp=.o) \
			$(CONFIG_VAL:.cpp=.o) \
			$(MAIN:.cpp=.o) \
			$(REQUEST:.cpp=.o) \
			$(TARGET:.cpp=.o) \
			$(UTILS:.cpp=.o) \
			$(CGI:.cpp=.o) \
			$(RESPONSE:.cpp=.o) \
			$(CONNECTION:.cpp=.o) \
			$(SERVER:.cpp=.o) \
			$(ERROR:.cpp=.o)

NAME = webserv

all: $(NAME)

$(NAME): $(OFILES) 
	@$(COMPILE) $(FLAGS) $(OFILES) -o $@ 

%.o: %.cpp
	$(COMPILE) $(FLAGS) -c $< -o $@

clean:
	@$(RM) $(OFILES)
	@rm -rf obj/

fclean: clean
	@$(RM) $(NAME) 
	@$(RM) -rf google_test/*/build
	cp Makefile docs/config_info/tmp_makefile


re: fclean all

test: re
	./$(NAME)