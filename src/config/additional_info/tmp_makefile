COMPILE = c++

FLAGS = -Wall -Werror -Wextra -std=c++11

MAIN = cgihandler_main.cpp

#directories
OBJDIR = obj
SRC_DIR = src
REQ_DIR = request
CONFIG_DIR = config
TARGET_DIR = resolved_target
UTILS_DIR = utils
CGI_DIR = cgi
RESP_DIR = response

REQUEST = $(addprefix $(SRC_DIR)/$(REQ_DIR)/,	chunked_parser.cpp \
											header_field_parser.cpp \
											request_line_parser.cpp \
											request.cpp \
											request_parser.cpp \
											request_target_parser.cpp \
											request_validator.cpp \
											uri_host_parser.cpp \
											uri.cpp)

CONFIG = $(addprefix $(SRC_DIR)/$(CONFIG_DIR)/,	config_interface.cpp \
												setup.cpp \
												server_name.cpp \
												server_context.cpp \
												listen.cpp \
												location_context.cpp \
												nginx_config.cpp \
												config_utils.cpp \
												directive_validation/client_max_body_size.cpp \
												directive_validation/allowed_methods.cpp \
												directive_validation/autoindex.cpp \
												directive_validation/error_page.cpp \
												directive_validation/cgi_pass.cpp \
												directive_validation/index.cpp \
												directive_validation/location_uri.cpp \
												directive_validation/return_dir.cpp \
												directive_validation/root.cpp)


TARGET = 	$(addprefix $(SRC_DIR)/$(TARGET_DIR)/,	server_selection.cpp \
													resolved_path.cpp \
															location_selection.cpp \
															target_config.cpp)

UTILS = 	$(addprefix $(SRC_DIR)/$(UTILS_DIR)/,	file_handling.cpp \
													is_functions.cpp \
													request_utils.cpp \
													cgi_utils.cpp)

CGI = $(addprefix $(SRC_DIR)/$(CGI_DIR)/, cgi.cpp \
											cgi_argv_envp.cpp \
											cgi_file_validation.cpp \
											cgi_parent_child.cpp \
											cgi_pathfinder.cpp \
											cgi_handler.cpp)

RESPONSE = $(addprefix $(SRC_DIR)/$(RESP_DIR)/, file_handler.cpp \
												response_handler.cpp \
												response.cpp)

OFILES = $(CONFIG:.cpp=.o) $(MAIN:.cpp=.o) $(REQUEST:.cpp=.o) $(TARGET:.cpp=.o) $(UTILS:.cpp=.o) $(CGI:.cpp=.o)

NAME = webserv

all: $(NAME)

$(NAME): $(OFILES) 
	@$(COMPILE) $(FLAGS) $(OFILES) -o $@ 

%.o: %.cpp
	$(COMPILE) $(FLAGS) -c $< -o $@

clean:
	@$(RM) $(OFILES)
	@rm -rf obj/

fclean: clean
	@$(RM) $(NAME) 
	@$(RM) -rf google_test/nginx/build
	@$(RM) -rf src/cgi/cgi_test/build
	cp Makefile src/config/additional_info/tmp_makefile

re: fclean all

test: re
	./$(NAME)